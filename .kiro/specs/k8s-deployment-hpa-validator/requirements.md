# 要件書

## 概要

kindで構築したKubernetes環境において、1 replicaのDeploymentにHorizontalPodAutoscaler（HPA）が紐づくことを防ぐカスタムコントローラーを実装する。ArgoCDによる管理環境で、DeploymentとHPAが同時にデプロイされる可能性を考慮した設計とする。

## 要件

### 要件1

**ユーザーストーリー:** Kubernetes管理者として、1 replicaのDeploymentにHPAが誤って設定されることを防ぎたい。これにより、リソースの無駄遣いと設定ミスを回避できる。

#### 受け入れ基準

1. WHEN 1 replica設定のDeploymentが作成または更新される AND そのDeploymentを対象とするHPAが存在する THEN システムはDeploymentの作成/更新を拒否する
2. WHEN HPAが作成または更新される AND 対象のDeploymentのreplicasが1に設定されている THEN システムはHPAの作成/更新を拒否する
3. WHEN DeploymentとHPAが同時にデプロイされる（ArgoCDシナリオ） AND Deploymentのreplicasが1に設定されている THEN システムは両方のリソースのデプロイを拒否する

### 要件2

**ユーザーストーリー:** 開発者として、バリデーションエラーが発生した際に、問題の原因と解決方法を明確に理解したい。

#### 受け入れ基準

1. WHEN バリデーションが失敗する THEN システムは日本語で明確なエラーメッセージを提供する
2. WHEN エラーが発生する THEN エラーメッセージには問題の詳細と推奨される解決策を含む
3. WHEN ログが出力される THEN 運用者が問題を特定できる十分な情報を含む

### 要件3

**ユーザーストーリー:** システム管理者として、カスタムコントローラーをkind環境で簡単にデプロイし、動作確認できるようにしたい。

#### 受け入れ基準

1. WHEN カスタムコントローラーがデプロイされる THEN kind環境で正常に動作する
2. WHEN テストケースが実行される THEN 全ての検証シナリオが自動的にテストされる
3. WHEN 実装が完了する THEN 詳細な実装手順とテスト手順が提供される

### 要件4

**ユーザーストーリー:** 開発チームとして、既存のワークロードに影響を与えることなく、新しいバリデーション機能を導入したい。

#### 受け入れ基準

1. WHEN カスタムコントローラーが動作する THEN 既存の正常なDeploymentとHPAの組み合わせには影響しない
2. WHEN システムが稼働する THEN パフォーマンスへの影響は最小限に抑えられる
3. IF バリデーション機能を無効化する必要がある THEN 簡単に無効化できる仕組みを提供する